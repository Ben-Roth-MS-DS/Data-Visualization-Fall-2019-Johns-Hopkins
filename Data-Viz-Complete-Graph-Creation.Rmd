---
title: "Data Viz: Complete Portfolio"
author: "Bejamin Roth"
date: "11/29/2019"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(include = F)
knitr::opts_chunk$set(message = F)
getwd()
library(maps)
library(scales)
library(stringr)
library(viridis)
library(mapdata)
library(rvest)
library(tidyverse)
library(lubridate)
library(rvest)
library(RColorBrewer)
library(dplyr)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(reshape2)
library(tidyquant)
library(ggalluvial)
library(zipcode)
```



```{r}
polls = read.csv("./Project/Data/president_primary_polls.csv")


expend = read.csv("./Project/Data/expend2017_2020.csv")

contr1 = read.csv("./Project/Data/contr_jan1_mar31_2019.csv")
contr2 = read.csv("./Project/Data/contr_apr1_may31_2019.csv")
contr3 = read.csv("./Project/Data/contr_601_1231_2019.csv")
contr4 = read.csv("./Project/Data/contr_2017_2018.csv")

contr1$contribution_receipt_date = as.character(contr1$contribution_receipt_date)
contr1$contribution_receipt_date = str_replace(contr1$contribution_receipt_date, "/19 ", "/2019")
contr1$contribution_receipt_date = as.Date(contr1$contribution_receipt_date, format = "%m/%d/%Y")

contr2$contribution_receipt_date = as.character(contr2$contribution_receipt_date)
contr2$contribution_receipt_date = str_replace(contr2$contribution_receipt_date, "/19 ", "/2019")
contr2$contribution_receipt_date = as.Date(contr2$contribution_receipt_date, format = "%m/%d/%Y")

contr3$contribution_receipt_date = as.character(contr3$contribution_receipt_date)
contr3$contribution_receipt_date = str_replace(contr3$contribution_receipt_date, "/19 ", "/2019")
contr3$contribution_receipt_date = as.Date(contr3$contribution_receipt_date, format = "%m/%d/%Y")

contr4$contribution_receipt_date = as.character(contr4$contribution_receipt_date)
contr4$contribution_receipt_date = str_replace(contr4$contribution_receipt_date, "00:00:00", '')
contr4$contribution_receipt_date = as.Date(contr4$contribution_receipt_date, format = "%Y-%m-%d")


cm = read.csv("./Project/Data/cm.csv")
```

```{r}
contr = rbind(contr1, contr2, contr3, contr4)

contr = contr %>%
  group_by(committee_name) %>%
  mutate(count = n()) 

contr.filt = contr %>%
  filter(count > 19 | committee_name == "COMMITTEE FOR PEACE, JUSTICE, AND MIKE GRAVEL") %>%
  ungroup()

contr.filt = contr.filt %>%
  filter(committee_name != "DONALD J. TRUMP FOR PRESIDENT, INC.",
         committee_name != "WELD 2020 PRESIDENTIAL CAMPAIGN COMMITTEE, INC.",
         count > 100) %>%
  ungroup()


contr.filt = droplevels(contr.filt)

contr.filt = contr.filt %>%
  filter(year(contribution_receipt_date) ==2019,
         month(contribution_receipt_date) < 7)

committee.names = c("BETO FOR AMERICA", "HICKENLOOPER 2020", "SETH MOULTON FOR AMERICA, INC.", "FRIENDS OF ANDREW YANG", "AMY FOR AMERICA", "GILIBRAND 2020", "TULSI NOW", "INSLEE FOR AMERICA", "KAMALA HARRIS FOR THE PEOPLE", "BERNIE 2020", "JULIAN FOR THE FUTURE", "PETE FOR AMERICA, INC.", "WARREN FOR PRESIDENT, INC.", "FRIENDS OF JOHN DELANEY", "CORY 2020", "MARIANNE WILLIAMSON FOR PRESIDENT", "DARIO FOR AMERICA", "BENNET FOR AMERICA", "SWALWELL FOR AMERICA", "TIM RYAN FOR AMERICA", "BIDEN FOR PRESIDENT", "DE BLASIO 2020", "BULLOCK FOR PRESIDENT", "JULIAN FOR THE FUTURE PRESIDENTIAL EXPLORATORY COMMITTEE")
candidate.names = c("O'Rourke", "Hickenloop", "Moulton", "Yang", "Klobuchar", "Gillibrand", "Gabbard", "Inslee", "Harris", "Sanders", "Castro", "Buttigieg", "Warren", "Delaney", "Booker", "Williamson", "Hunter", "Bennet", "Swalwell", "Ryan", "Biden", "Blasio", "Bullock", "Castro")

candidate.matching = data.frame(committee.names, candidate.names)

contr.names = merge(contr.filt, candidate.matching, by.x = "committee_name", by.y = "committee.names")
table(contr.names$committee_name)

top.cand = contr.filt %>%
  group_by(committee_name) %>%
  summarise(count = n())

expend$disbursement_description = str_to_lower(expend$disbursement_description)

fees = c('fee', 'service', 'expens', 'charge', 'process')
travel = c('travel', 'airline', 'road', 'trans', 'car', 'tax', 'air', 'amtrak', 'fuel', 'trip', 'bus', 'car', 
           'hostel', 'hotel', 'airbnb', 'auto', 'room in', 'stay at', 'bag check', 'flight', 'carly return', 
           'carly to', 'baggage', 'andrew going home', 'andrew sf to ny', 'lodg', 'gas', 'vehicle', 'matt and andrew', 
           'matt shinners', 'flight', 'per diem', 'petty cash', 'uber', 'train', 'parking')
advert = c('avert', 'ad ', 'ads ', 'instagram', 'billboard', 'media')
admin = c('postage', 'trash', 'payroll', 'admin', 'utilities', 'marketing', 'moving', 'print', 'payrol', 'suppl',
          'cleaning', 'shipping', 'presentation', 'postage', 'office', 'package', 'stamp', 'storage', 'salary')
tech = c('software', 'adobe', 'computer', 'tech', 'programming', 'saas', 'google', 'cloud', 'hardware', 'web design',
         'web', 'information technology', 'internet', 'app', 'canva')
merch = c('button', 'merchandise', 'merch', 'shirt', 'hat')
event = c('cater', 'host', 'event', 'pizza', 'food', 'sound', 'site', 'venue', 'registration', 'register')
refund = c('reimburse', 'refund')

expend.filt = expend %>%
  filter(committee_name %in% top.cand$committee_name) %>%
  mutate(disbursement.category = 
           ifelse(disbursement_description %in% fees, 'Fees, Expenses, and Services', 
           ifelse(grepl(x = disbursement_description, pattern = 'credit card'), 'Credit Card Fees',
           ifelse(disbursement_description %in% travel, 'Travel', 
           ifelse(disbursement_description %in% advert, 'Advertising', 
           ifelse(disbursement_description %in% admin, 'Administrative',
           ifelse(grepl(x = disbursement_description, pattern = 'field'), 'Field',
           ifelse(disbursement_description %in% tech, 'Technology',
           ifelse(disbursement_description %in% merch, 'Merchandise', 
           ifelse(disbursement_description %in% event, 'Event', 
           ifelse(disbursement_description %in% refund, 'Refunds',
           ifelse(grepl(x = disbursement_description, pattern = 'fundrais'), 'Fundraising', 'Other'))))))))))))

expend.names = merge(expend.filt, candidate.matching, by.x = "committee_name", by.y = "committee.names")

```


## Graph 1
```{r}
#load in US map
states = map_data("state")

#scrape US postal abbreviations, create df
url = "https://www.factmonster.com/us/postal-information/state-abbreviations-and-state-postal-codes"

download.file(url, destfile = "scrapedpage.html", quiet=TRUE)
page <- read_html("scrapedpage.html")

table_text = page %>%
  html_nodes("table") %>%
  html_nodes("tr") %>%
  html_nodes("td") %>%
  html_text()

dtAbbr = data.frame(matrix(table_text, ncol = 3, byrow = TRUE))



dtAbbr$X2 = NULL

colnames(dtAbbr) = c("State","Abbreviation")

dtAbbr$State = as.character(dtAbbr$State)

dtAbbr$State[10] = "District of Columbia"
```


```{r}

contr.select = contr.filt %>%
  select(committee_name, contributor_state, receipt_type_desc, contribution_receipt_date, contribution_receipt_amount)

contr.mutate = contr.select %>%
  group_by(contributor_state) %>%
  summarise(state_contr_per_capita = mean(contribution_receipt_amount))


dtMerge_Contr = merge(dtAbbr, contr.mutate, by.x = "Abbreviation", by.y = "contributor_state")

dtMerge_Contr$Abbreviation = toupper(dtMerge_Contr$Abbreviation)
dtMerge_Contr$State = tolower(dtMerge_Contr$State)

#trim leading/trailing white space
dtMerge_Contr$State <- trimws(dtMerge_Contr$State)

#remove any whitespace in the middle
dtMerge_Contr$State = str_squish(dtMerge_Contr$State)

#make all upper case to match Farm dtDona
dtMerge_Contr$State <- toupper(dtMerge_Contr$State)


#trim leading/trailing white space
states$region <- trimws(states$region)

#remove any whitespace in the middle
states$region = str_squish(states$region)

#make all upper case to match Farm dtDona
states$region <- toupper(states$region)


dtMap_Contr = merge(states, dtMerge_Contr, by.x = "region", by.y = "State")
```

```{r, include = T}
contr_map = dtMap_Contr %>%
  ggplot() + 
  geom_polygon(aes(x = long, y = lat, group = group, fill = state_contr_per_capita), color = 'black') +
  coord_quickmap() +
  theme_classic() + 
  labs(x = "",
       y = "",
       subtitle = "Average Amount Per Contribution, by State",
       caption = "Source: FEC Data, 1/1/2019 - 6/30/2019",
       title = 'New York, Colorado, Delaware, Florida, New Jersey Top Five States in Average Contribution Amount') +
  scale_fill_continuous(name = "Average Amount\nPer Contribution",
                       low = "grey",
                       high = "blue",
                       labels = dollar) +
  theme(axis.title = element_text(color="#666666", face="bold", size=10))+
  theme(plot.title = element_text(color="#666666", face="bold", size=14))+
  theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank())
  #guides(fill=guide_legend(title="Log of Avg.\nInitial Reserve")) +

contr_map
```


## Graph 2


```{r, include = F, echo = F}
contr.select = contr.names %>%
  select(candidate.names, contributor_state, receipt_type_desc, contribution_receipt_date, contribution_receipt_amount) 

contr.mutate = contr.select %>%
  group_by(contributor_state) %>%
  summarise(state_contr_total = sum(contribution_receipt_amount))
```





```{r, include = F, echo = F}
contr.select$candidate.names = droplevels(contr.select$candidate.names)

contr.summ = contr.select %>%
  group_by(candidate.names) %>%
  summarise(total.contributions = sum(contribution_receipt_amount))


expend.names$candidate.names = droplevels(expend.names$candidate.names)

expend.select = expend.names %>%
  select(candidate.names, recipient_state, recipient_name, disbursement_amount, disbursement_description) 

expend.summ = expend.select %>%
  group_by(candidate.names) %>%
  summarise(total.expenditures = sum(disbursement_amount))

expend.contr = merge(contr.summ, expend.summ, by = "candidate.names")

expend.contr = expend.contr %>%
  arrange(desc(total.contributions))

top.contr.expend = head(expend.contr, 10)

top.contr.expend = top.contr.expend %>%
  mutate(expend.contr.prop = total.expenditures/total.contributions)
```


```{r, echo = F, include = F}

scaleFUN <- function(x) sprintf("%.2f", x)


plt = top.contr.expend %>%
  ggplot(aes(reorder(candidate.names, expend.contr.prop), expend.contr.prop)) + 
  geom_bar(stat = "identity", fill = "blue") + 
  theme_classic() + 
  theme(axis.title = element_text(color="#666666", face="bold", size=10))+
  theme(plot.title = element_text(color="#666666", face="bold", size=13))+
  theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
  labs(title = "Dollars Spent per Dollars Received: Democratic 2020 Presidential\nPrimary Candidates (Top 10 Contributions Received)",
       subtitle = 'Per FEC Data, A Majority of Top Candidates are Spending More Than They Receive',
       caption = "Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019",
       x = "Candidate Committee Name",
       y = "Dollar Spent per Dollars Received") +
  scale_y_continuous(labels = dollar) + 
  geom_text(aes(label=paste("$",round(expend.contr.prop,2), sep = '')), hjust=-0.25) + 
  ylim(0,3.50) + 
  coord_flip()
  

ggsave(plot = plt, filename = "Dollars Spent Per Dollars Received.pdf", path = paste("./Project/Graphs/"))

```




```{r, include = T}
plt
```


## Graph 6
```{r}

expend.names2 = expend.names %>%
  group_by(candidate.names) %>%
  mutate(total.disbursement = sum(disbursement_amount))
  

expend.names2$candidate.names = droplevels(expend.names$candidate.names)

expend.disb.perc = expend.names2 %>% 
  group_by(candidate.names, disbursement.category) %>%
  mutate(Disbursement.Percent.Total = sum(disbursement_amount)/total.disbursement)

expend.disb.summ = expend.disb.perc  %>%
  group_by(disbursement.category, candidate.names) %>%
  summarize(Disbursement.Percent.Total = mean(Disbursement.Percent.Total),
            Total.Disbursement = mean(total.disbursement)) %>%
  mutate(Disbursement.Percent.Total = na.fill(Disbursement.Percent.Total, 0),
         Total.Disbursement = na.fill(Total.Disbursement, 0))

expend.disb.summ = expend.disb.summ %>% select(-Total.Disbursement)


test.df =  with(expend.disb.summ, 
                expand.grid(x = as.factor(disbursement.category),
                            y = as.factor(candidate.names)))

expend.all.filled = merge(expend.disb.summ, test.df,
                          by.y = c('x','y'),
                          by.x = c('disbursement.category', 'candidate.names'),
                          all.x = T)

expend.all.filled = expend.all.filled %>%
  group_by(disbursement.category, candidate.names) %>%
  summarise(Disbursement.Percent.Total = mean(Disbursement.Percent.Total))

expend.all.wide = data.frame(dcast(expend.all.filled, disbursement.category ~ candidate.names, value.var = 'Disbursement.Percent.Total'))
 
expend.all.wide$disbursement.category = as.character(expend.all.wide$disbursement.category)

expend.all.wide = na.fill(expend.all.wide, 0)

expend.all.wide.select = expend.all.wide %>% select(!disbursement.category)

expend.cor = round(cor(expend.all.wide), 2)

colnames(expend.cor) = c("Administrative", 'Advertising', 'Contributions', 'Events', 'Fundraising', 'Repayments', 'Materials', 'Other', 'Refunds', 'Transfers', 'Travel')

rownames(expend.cor) = c("Administrative", 'Advertising', 'Contributions', 'Events', 'Fundraising', 'Repayments', 'Materials', 'Other', 'Refunds', 'Transfers', 'Travel')


plt.cor = ggcorrplot(expend.cor, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="square", 
           colors = c("red", "white", "blue"), 
           labs(title="Correlation of Disbursement Purpose Categories",
                subtitle = "Democratic 2020 Primary Candidate Data"),
           outline.color = 'black',
           legend.title = 'Correlation',
           ggtheme=theme_classic)
```


```{r, include = T}
plt.cor
```


## Graph 8
```{r, echo = F, include = T}
expend.filt = expend %>%
  filter(committee_name %in% top.cand$committee_name) %>%
  ungroup() %>%
  merge(.,candidate.matching, by.x = "committee_name", by.y = "committee.names") %>%
  filter(disbursement.category != 'OTHER' &
         candidate.names != 'Hunter') %>%
  group_by(candidate.names) %>%
  mutate(total.disbursement = sum(disbursement_amount))
  
expend.disb.perc = expend.filt %>% 
  group_by(candidate.names, disbursement.category) %>%
  mutate(Disbursement.Percent.Total = sum(disbursement_amount)/total.disbursement)

expend.disb.summ = expend.disb.perc  %>%
  group_by(disbursement.category, candidate.names) %>%
  summarize(Disbursement.Percent.Total = mean(Disbursement.Percent.Total),
            Total.Disbursement = mean(total.disbursement))

  
test.df =  with(expend.disb.summ, 
                expand.grid(disbursement.category = levels(disbursement.category),
                            candidate.names = levels(candidate.names)))

expend.all.filled = merge(test.df, expend.disb.summ %>% select(-Total.Disbursement),
                          by.x = c('disbursement.category','candidate.names'),
                          by.y = c('disbursement.category', 'candidate.names'),
                          all.x = T)


expend.all.filled[is.na(expend.all.filled)] = 0

levels(expend.all.filled$disbursement.category) = 
  c("Administrative", "Advertising", "Contributions", "Events", "Fundraising", "Loan-Repayments", "Materials", "Other", "Refunds", "Transfers", "Travel")

plt.heat = expend.all.filled %>%
  filter(disbursement.category != 'Other') %>%
  ggplot(aes(disbursement.category, candidate.names)) + 
    geom_raster(aes(fill = Disbursement.Percent.Total)) +
    theme_classic() + 
    theme(axis.title = element_text(color="#666666", face="bold", size=10))+
    theme(plot.title = element_text(color="#666666", face="bold", size=14))+
    theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
    theme(plot.caption = element_text(color="#666666", face="bold.italic", size=8)) +
    labs(title = 'Heatmap of Campaign Spending in Major FEC Categories,\n2020 President Election Democratic Primary Candidates',
         subtitle = 'Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019',
         x = 'Disbursement Purpose Category',
         y = 'Democratic Primary Candidate') + 
    theme(legend.position = "right") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    scale_fill_gradient(low = "lightblue1", high = "darkblue",limits=c(0,1), labels = percent,
                        name = 'Percent of Total\nCampaign Spending')


plt.heat
```

## Graph 9

```{r, include = F, echo = F, warning = F}
#group by day of week
contr.group.date = contr.names %>%
  group_by(contribution_receipt_date) %>%
  summarise(Date.Total.Amount = sum(contribution_receipt_amount))

#finding the day no. of the week
contr.group.date$weekday = as.numeric(as.POSIXlt(contr.group.date$contribution_receipt_date)$wday)

#converting the day no. to factor 
contr.group.date$weekdayf = factor(contr.group.date$weekday,levels=rev(1:7),
                           labels=rev(c("Mon","Tue","Wed","Thu","Fri","Sat","Sun")),
                           ordered=TRUE) 

# finding the month
contr.group.date$monthf=factor(month(contr.group.date$contribution_receipt_date),
                              levels=as.character(1:12), 
                              labels=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"), 
                              ordered=TRUE)
                                


#finding the year and the month from the date. Eg: Nov 2018 
contr.group.date$yearmonth = factor(as.yearmon(contr.group.date$contribution_receipt_date)) 

#finding the week of the year for each date 
contr.group.date$week = as.numeric(format(contr.group.date$contribution_receipt_date,"%W"))

contr.group.date$weekdayf[is.na(contr.group.date$weekdayf)] = 'Sun'





detach(package:dplyr)
library(plyr)
library(plotly)
#normalizing the week to start at 1 for every month 
contr.group.date = ddply(contr.group.date,.(yearmonth),transform,monthweek=1+week-min(week)) 

contr.group.date2019 = contr.group.date %>%
    filter(year(contribution_receipt_date) == 2019,
           monthf != 'Jul',
           monthf != 'Aug')

detach(package:plyr)
library(dplyr)
View(contr.group.date2019 %>%
  mutate(month = month(contribution_receipt_date)) %>%
  group_by(factor(month)) %>% summarise(monthly.total = mean(Date.Total.Amount)))


pltDate.Amt = 
  contr.group.date2019 %>%
  ggplot(aes(monthweek, weekdayf, fill = contr.group.date2019$Date.Total.Amount/1000)) +
    geom_tile(colour = "black") + 
    facet_grid(year(contr.group.date2019$contribution_receipt_date)~monthf) +
    scale_fill_gradient(low="white", high="blue", labels=dollar) + 
    xlab("") +
    ylab("") + 
    ggtitle("Biden and O'Rourke Entrie, Ends of Quarters Highest Fundraising Days") + 
    labs(fill = "Contribution Amount\n(In Thousands)",
         caption = 'Code: "Time-Series Calendar Heatmap" by Sarang Gupta, http://www.columbia.edu/~sg3637/blog/Time_Series_Heatmaps.html',
         subtitle = 'Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019') +
    theme_classic() + 
    theme(axis.title = element_text(color="#666666", face="bold", size=10))+
    theme(plot.title = element_text(color="#666666", face="bold", size=14))+
    theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
    theme(plot.caption = element_text(color="#666666", face="bold.italic", size=8)) +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) +
    theme(legend.position = 'bottom') + 
    guides(fill = guide_colourbar(barwidth = 15, barheight = 1))

ggsave(plot = pltDate.Amt, filename = "Daily Contribution Amount Heatmap.pdf", 
       path = "./Project/Graphs/")
```

```{r, include = T, echo = F}
pltDate.Amt
```

\n

Looking at the above calendar, it is clear that total contributions have steadily increased over time, with a few days having a noticably larger amount of contributions. It would make sense to me why the end of March or the end of June would have large funding days, as campaigns push for additional contributions at the end of each quarter. The second Thursday in March, another significant contribution day, was the day that O'Rourke announced his official run for the presidency. April 25th, the significant funding day in April, was the day the Biden officially announced his run for the presidency.


\n

## Graph 10

\n

For the second graph, I focus on which candidates had the highest fundraising day, each day for the first half of 2019:

\n
```{r, include = F, echo = F}
detach(package:plyr)
library(dplyr)
contr.group.cand = contr.names %>%
  group_by(candidate.names, contribution_receipt_date) %>%
  summarise(Cand.Don.Amt = sum(contribution_receipt_amount)) %>%
  arrange(contribution_receipt_date, desc(Cand.Don.Amt)) %>%
  filter(year(contribution_receipt_date) == 2019)

contr.top.cand = contr.group.cand %>%
  group_by(contribution_receipt_date) %>%
  top_n(n = 1, wt = Cand.Don.Amt)
```

```{r, include = F, echo = F}
#finding the day no. of the week
contr.top.cand$weekday = as.numeric(as.POSIXlt(contr.top.cand$contribution_receipt_date)$wday)

#converting the day no. to factor 
contr.top.cand$weekdayf = factor(contr.top.cand$weekday,levels=rev(1:7),
                           labels=rev(c("Mon","Tue","Wed","Thu","Fri","Sat","Sun")),
                           ordered=TRUE) 

# finding the month
contr.top.cand$monthf=factor(month(contr.top.cand$contribution_receipt_date),
                              levels=as.character(1:12), 
                              labels=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"), 
                              ordered=TRUE)
                                


#finding the year and the month from the date. Eg: Nov 2018 
contr.top.cand$yearmonth = factor(as.yearmon(contr.top.cand$contribution_receipt_date)) 

#finding the week of the year for each date 
contr.top.cand$week = as.numeric(format(contr.top.cand$contribution_receipt_date,"%W"))

contr.top.cand$weekdayf[is.na(contr.top.cand$weekdayf)] = 'Sun'

detach(package:dplyr)
library(plyr)
#normalizing the week to start at 1 for every month 
contr.top.cand = ddply(contr.top.cand,.(yearmonth),transform,monthweek=1+week-min(week)) 
```

```{r, echo = F, include = F}
contr.top.cand = contr.top.cand %>%
  filter(monthf != 'Jul',
         monthf != 'Aug')

color = grDevices::colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]


n = length(unique(contr.top.cand$candidate.names))

qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]

col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))


pltDate.Cand = 
  contr.top.cand %>%
  ggplot(aes(monthweek, weekdayf, fill = candidate.names)) +
    geom_tile(colour = "black") + 
    facet_grid(year(contr.top.cand$contribution_receipt_date)~monthf) +
    xlab("") +
    ylab("") + 
    ggtitle("Through First Six Months of 2019, Fundraising Days Show Frequent Shifts\nin Candidate with Highest Fundraising Day") +
    labs(fill = "Democratic Presidential\nPrimary Candidate",
         caption = 'Code: "Time-Series Calendar Heatmap" by Sarang Gupta, http://www.columbia.edu/~sg3637/blog/Time_Series_Heatmaps.html',
         subtitle = 'Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019') +
    theme_classic() + 
    theme(axis.title = element_text(color="#666666", face="bold", size=10))+
    theme(plot.title = element_text(color="#666666", face="bold", size=14))+
    theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
    theme(plot.caption = element_text(color="#666666", face="bold.italic", size=8)) +
    theme(legend.position = 'bottom') + 
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) +
    scale_fill_manual(values = col_vector)

ggsave(plot = pltDate.Cand, filename = "Top Daily Campaign Timeline.pdf", 
       path = "./Project/Graphs/")
```

```{r, include = T, echo = F}
pltDate.Cand
```


## Graph 11

```{r}
detach(package:plyr)
library(dplyr)
contr.group.cand = contr.names %>%
  group_by(candidate.names, contributor_state) %>%
  summarise(Cand.Don.Amt = sum(contribution_receipt_amount)) %>%  
  arrange(contributor_state, desc(Cand.Don.Amt)) 

contr.top.cand = contr.group.cand %>%
  group_by(contributor_state) %>%
  top_n(n = 1, wt = Cand.Don.Amt)


dtMerge_Contr = merge(dtAbbr, contr.top.cand, by.x = "Abbreviation", by.y = "contributor_state")

dtMerge_Contr$Abbreviation = toupper(dtMerge_Contr$Abbreviation)
dtMerge_Contr$State = tolower(dtMerge_Contr$State)
```



```{r, include = F}
#Contributions

#trim leading/trailing white space
dtMerge_Contr$State <- trimws(dtMerge_Contr$State)

#remove any whitespace in the middle
dtMerge_Contr$State = str_squish(dtMerge_Contr$State)

#make all upper case to match Farm dtDona
dtMerge_Contr$State <- toupper(dtMerge_Contr$State)


#trim leading/trailing white space
states$region <- trimws(states$region)

#remove any whitespace in the middle
states$region = str_squish(states$region)

#make all upper case to match Farm dtDona
states$region <- toupper(states$region)


dtMap_Contr = merge(states, dtMerge_Contr, by.x = "region", by.y = "State")

```



```{r}


n = length(unique(dtMap_Contr$candidate.names))

qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]

col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
```


```{r}
val_cols = c("darkblue", "darkred", "darkgreen",  "azure4", "chocolate", "khaki2","mediumorchid4",
             "chartreuse", "darkgoldenrod1", "darkseagreen1","deeppink1", "red", "skyblue")

#graph maps
contr_map = dtMap_Contr %>%
  ggplot() + 
  geom_polygon(aes(x = long, y = lat, fill = candidate.names, group = group), color = "black") +
  coord_quickmap() +
  theme_classic() + 
  labs(x = "",
       y = "",
       title = "Democratic 2020 Presidential Primary: Highest\n Campaign Contribution Amount, By State",
       caption = "Source: FEC Data, 1/1/2019 - 6/30/2019",
       subtitle = 'Through First Six Months, Pete Buttigieg Leads in Total Fundraising Dollars\nin Three of Four First Primary States') +
  scale_fill_manual(values = val_cols) +
  theme(axis.title = element_text(color="#666666", face="bold", size=10)) +
  theme(plot.title = element_text(color="#666666", face="bold", size=14)) +
  theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10)) +
theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank()) + 
  guides(fill=guide_legend(title= "Candidate")) 
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

ggsave(plot = contr_map, filename = "Top Campaign Contribution Amounts by State.pdf", 
       path = "./Project/Graphs/")  
```



```{r, include = T}
contr_map
```


## Graph 12

```{r}
contr.group.cand = contr.names %>%
  group_by(candidate.names, contributor_state) %>%
  summarise(Cand.Don.Cnt = n()) %>%
  arrange(contributor_state, desc(Cand.Don.Cnt)) 

contr.top.cand = contr.group.cand %>%
  group_by(contributor_state) %>%
  top_n(n = 1, wt = Cand.Don.Cnt)

contr.top.2.cand = contr.group.cand %>%
  group_by(contributor_state) %>%
  top_n(n = 2, wt = Cand.Don.Cnt)
table(contr.top.2.cand$candidate.names)

dtMerge_Contr = merge(dtAbbr, contr.top.cand, by.x = "Abbreviation", by.y = "contributor_state")

dtMerge_Contr$Abbreviation = toupper(dtMerge_Contr$Abbreviation)
dtMerge_Contr$State = tolower(dtMerge_Contr$State)
dtMerge_Contr = merge(dtAbbr, contr.top.cand, by.x = "Abbreviation", by.y = "contributor_state")

dtMerge_Contr$Abbreviation = toupper(dtMerge_Contr$Abbreviation)
dtMerge_Contr$State = tolower(dtMerge_Contr$State)
```


```{r, include = F}
#Contributions

#trim leading/trailing white space
dtMerge_Contr$State <- trimws(dtMerge_Contr$State)

#remove any whitespace in the middle
dtMerge_Contr$State = str_squish(dtMerge_Contr$State)

#make all upper case to match Farm dtDona
dtMerge_Contr$State <- toupper(dtMerge_Contr$State)


#trim leading/trailing white space
states$region <- trimws(states$region)

#remove any whitespace in the middle
states$region = str_squish(states$region)

#make all upper case to match Farm dtDona
states$region <- toupper(states$region)


dtMap_Contr = merge(states, dtMerge_Contr, by.x = "region", by.y = "State")
```



```{r}
colors = c("Biden" = "darkblue",   "Buttigieg" =  "azure4","Klobuchar" = "chartreuse",  "O'Rourke" = "darkgoldenrod1",  "Sanders" = "deeppink1", "Warren" = "red")


#graph maps
contr_map2 = dtMap_Contr %>%
  ggplot() + 
  geom_polygon(aes(x = long, y = lat, fill = candidate.names, group = group), color = "black") +
  coord_quickmap() +
  theme_classic() + 
  labs(x = "",
       y = "",
       title = "Democratic 2020 Presidential Primary: Most\nCampaign Contributions, By State",
       subtitle = "Source: FEC Data, 1/1/2019 - 6/30/2019") +
  scale_fill_manual(values = val_cols) +
  theme(axis.title = element_text(color="#666666", face="bold", size=10)) +
  theme(plot.title = element_text(color="#666666", face="bold", size=14)) +
  theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank()) + 
  guides(fill=guide_legend(title= "Candidate")) 
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))

ggsave(plot = contr_map2, filename = "Top Campaign Contributions by State.pdf", 
       path = "./Project/Graphs/")
```



```{r, include = T}
contr_map2
```


## Graph 13

```{r}
expend.select = expend.names %>%

  mutate(disbursement.date = as_date(disbursement_date)) %>%

  group_by(candidate.names, disbursement.date) %>%

  summarise(daily.disbursement.amount = sum(disbursement_amount))

expend.select$candidate.names = str_replace_all(expend.select$candidate.names, 'Blasio', 'de Blasio')

expend.select$candidate.names = str_replace_all(expend.select$candidate.names, 'Hickenloop', 'Hickenlooper')

expend.select = expend.select %>%

  filter(year(disbursement.date) == 2019 & month(disbursement.date) < 10) %>%

  group_by(candidate.names) %>%

  complete(disbursement.date = seq.Date(as.Date(min(disbursement.date, na.rm = T)), max(disbursement.date, na.rm = T), by="day")) %>%

  mutate(daily.disbursement.amount  = na.fill(daily.disbursement.amount , 0))

contr.select = contr.names %>%

  mutate(contribution.receipt.date = as_date(contribution_receipt_date)) %>%

  group_by(candidate.names, contribution.receipt.date) %>%

  summarise(daily.contribution.amount = sum(contribution_receipt_amount))

contr.select$candidate.names = str_replace_all(contr.select$candidate.names, 'Blasio', 'de Blasio')

contr.select$candidate.names = str_replace_all(contr.select$candidate.names, 'Hickenloop', 'Hickenlooper')

 

contr.select = contr.select %>%

  filter(year(contribution.receipt.date) == 2019 & month(contribution.receipt.date) < 10) %>%

  group_by(candidate.names) %>%

  complete(contribution.receipt.date = seq.Date(as.Date(min(contribution.receipt.date, na.rm = T)), max(contribution.receipt.date, na.rm = T), by="day")) %>%

  fill(daily.contribution.amount)


polls.select = polls %>%

  filter(state == '' & party == 'DEM') %>%

  mutate(poll.date = dmy(end_date)) %>%

  group_by(answer, poll.date) %>%

  summarise(avg.poll = mean(pct))

 

polls.select = polls.select %>%

  filter(year(poll.date) == 2019 & month(poll.date) < 10 & answer %in% contr.select$candidate.names) %>%

  group_by(answer) %>%

  complete(poll.date = seq.Date(as.Date(min(poll.date, na.rm = T)), max(poll.date, na.rm = T), by="day")) %>%

  fill(avg.poll)

 

polls.select$answer = droplevels(polls.select$answer)

```

 

 

```{r}

all.data = merge(contr.select, expend.select, by.x = c('contribution.receipt.date', 'candidate.names'), by.y = c('disbursement.date', 'candidate.names'), how = 'left')

all.data$candidate.names = droplevels(as.factor(all.data$candidate.names))

top.all.long = melt(all.data, id.vars = c('contribution.receipt.date', 'candidate.names'))


top.all.long$candidate.names = droplevels(top.all.long$candidate.names)


top.all.long = merge(top.all.long, polls.select, by.x =  c('contribution.receipt.date', 'candidate.names'),

                     by.y = c('poll.date', 'answer'), how = 'left')
```

 

 

```{r}

top.buttigieg = top.all.long %>% filter(candidate.names  %in% c('Buttigieg', 'Warren')) %>% mutate(avg.poll = avg.poll/100)

average.daily.contr.butt = mean((top.buttigieg %>% filter(candidate.names == 'Buttigieg', variable == 'daily.contribution.amount'))$value)*7
average.daily.contr.warren = mean((top.buttigieg %>% filter(candidate.names == 'Warren', variable == 'daily.contribution.amount'))$value)*7

average.daily.expend.butt = mean((top.buttigieg %>% filter(candidate.names == 'Buttigieg', variable == 'daily.disbursement.amount'))$value)*7
average.daily.expend.warren = mean((top.buttigieg %>% filter(candidate.names == 'Warren', variable == 'daily.disbursement.amount'))$value)*7

print(c(average.daily.contr.butt, average.daily.contr.warren, average.daily.expend.butt, average.daily.expend.warren))

colors = c('daily.contribution.amount' = 'Blue', 'daily.disbursement.amount' = 'Red')

plt.top.line = top.buttigieg %>%
  ggplot(aes(x= contribution.receipt.date, color = variable)) +
  geom_line(aes(x= contribution.receipt.date, y = value)) +
  scale_x_date(date_breaks = "1 month", date_minor_breaks = "1 week", date_labels = "%B") +
  scale_y_continuous(labels = dollar_format(prefix = "$")) +
  facet_wrap(candidate.names~., ncol = 1) +
  theme_classic() + 
  geom_hline(yintercept = average.daily.expend.butt, color = 'Red') +
  geom_hline(yintercept = average.daily.contr.butt, color = 'Blue') +
  geom_hline(yintercept = average.daily.expend.warren, color = 'Red') +
  geom_hline(yintercept = average.daily.contr.warren, color = 'Blue') +
  theme(axis.title = element_text(color="#666666", face="bold", size=10))+
  theme(plot.title = element_text(color="#666666", face="bold", size=13))+
  theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
  labs(title = "Comparing Dollars Spent and Dollars Received\nDuring 2020 Democratic Presidential Primary: Buttigieg and Warren",
       subtitle = 'No Clear Relationship Between Spending and Receiving',
       caption = "Source: Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019",
       x = "Month",
       y = "Dollars") +
  scale_color_manual(values = colors, labels = c('Contributions','Disbursements'), name = '') +
  theme(legend.position = "bottom")



plt.top.line


ggsave(plot = plt.top.line, filename = "Line Graph Dollars Spent per Dollars Received.pdf", path = paste("./Project/Graphs/"))

```

 

#Graph 14

```{r}

polls.top.month = polls %>%
  mutate(poll.date = dmy(end_date)) %>%
  filter(year(poll.date) == 2019 & month(poll.date) < 7 & answer %in% contr.select$candidate.names) %>%
  group_by(answer, poll.date) %>%
  summarise(poll.avg = mean(pct))
top.candidates = c('Biden', "Buttigieg", "Harris", "O'Rourke", "Sanders", "Warren")

polls.top.month = polls.top.month %>%
  arrange(poll.date, desc(poll.avg)) %>%
  group_by(poll.date) %>%
  mutate(answer = ifelse(answer %in% top.candidates, as.character(answer), 'Other Candidate')) 



polls.top.month$answer = factor(polls.top.month$answer, levels = c("Biden", "Sanders", "Warren", "Harris", "Buttigieg", "O'Rourke", 'Other Candidate'))
```


```{r, warnings = F}
colors = c("Biden" = "darkblue",   "Buttigieg" =  "azure4", "Harris" = "chocolate",    "O'Rourke" = "darkgoldenrod1",  "Sanders" = "deeppink1", "Warren" = "red", "Other Candidate" = "White")
outline = c("Biden" = "darkblue",   "Buttigieg" =  "azure4", "Harris" = "chocolate",    "O'Rourke" = "darkgoldenrod1",  "Sanders" = "deeppink1", "Warren" = "red", "Other Candidate" = "Black")

alluvial.polling = polls.top.month %>%
  group_by(poll.date, answer) %>%
  summarise(poll.avg = sum(poll.avg)) %>%
  ggplot(aes(x = poll.date, y = poll.avg/100)) +
  geom_area(aes(colour = answer, group=answer, fill = answer)) +
  scale_y_continuous(labels = percent) +
  scale_fill_manual(values = colors, name = 'Candidate') + 
  scale_color_manual(values = outline, name = 'Candidate') + 
  theme_classic() + 
  theme(axis.title = element_text(color="#666666", face="bold", size=10))+
  theme(plot.title = element_text(color="#666666", face="bold", size=13))+
  theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
  labs(title = "Joe Biden Maintains High Polling Throughout First Six Months of 2019",
       subtitle = 'Top Candidates Highlighted, Rest of Field Aggregated as "Other Candidate"',
       caption = "Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019",
       x = "Month",
       y = "Polling Average") 


alluvial.polling
ggsave(plot = alluvial.polling, filename = "Area Map Campaign Polling.pdf", path = paste("./Project/Graphs/"))
```


# Graph 15
```{r}
above_amount <- unname(quantile(expend.select$disbursement_amount, 0.975))
below_amount <- unname(quantile(expend.select$disbursement_amount, 0.025))

expend.select = expend.names %>%
  filter(disbursement_amount < above_amount) %>%
  select(disbursement_amount, recipient_state)


View(expend.select %>%
  group_by(recipient_state) %>%
  summarise(count = n()))

  
expend.group = expend.select %>%
  group_by(recipient_state) %>%
  summarise(total.spent = n())

expend.group$recipient_state = droplevels(expend.group$recipient_state)

# compute normalized total.spent
expend.group$total.spent.z <- round((expend.group$total.spent - mean(expend.group$total.spent))/sd(expend.group$total.spent), 2)  

# above / below avg flag
expend.group$total.spent.type <- ifelse(expend.group$total.spent < mean(expend.group$total.spent), "below", "above")  

expend.group = expend.group %>%
  filter(recipient_state %in% c('IA', 'NH', 'NV', 'SC', 'AL', 'AR', 'CO', 'ME', 'MA', 'MN', 'WA',
                                'NC', 'OK', 'TN', 'PR', 'UT', 'VT', 'VA', 'ID', 'MI', 'MS', "MO", 'ND'))

# sort
expend.group <- expend.group[order(expend.group$total.spent), ]  

expend.group$recipient_state <- factor(expend.group$recipient_state, levels = expend.group$recipient_state)
```

```{r}
avg.state.spent = 
  expend.group %>%
    ggplot(aes(x = recipient_state, y = total.spent.z, label = total.spent.z)) + 
    geom_bar(stat = 'identity', aes(fill = total.spent.type))  +
    geom_text(color = 'black', size = 2) +
    scale_fill_manual(name = "spent", 
                     labels = c("Above Average", "Below Average"), 
                     values = c("above" = "blue", "below" = "red")) + 
    ylim(c(-1.5, 2)) +
    scale_y_continuous(label = scaleFUN) +
    coord_flip() +
    theme_classic() +
    theme(axis.title = element_text(color="#666666", face="bold", size=10))+
    theme(plot.title = element_text(color="#666666", face="bold", size=13))+
    theme(plot.subtitle = element_text(color="#666666", face="bold.italic", size=10))+
    labs(title = "Number of Disbursements in First Twenty-Five Primary States",
        subtitle = 'Disbursements Normalized',
        caption = "Source: FEC Data, Date Range: 1/1/2019-6/30/2019, downloaded 9/21/2019",
        x = "State",
        y = "Normalized Disbursement Count")
    


ggsave(plot = avg.state.spent, filename = "Bar Graph Positive Negative.pdf", path = "./Project/Graphs/")


avg.state.spent
```
